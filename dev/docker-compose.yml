name: 'azubitafel'

services:
  public:
    image: 'caddy:latest'
    container_name: 'public'
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - data:/data
      - config:/config
      - www:/www
    command: ["caddy", "run", "-c", "/config/Caddyfile"]

  api:
    build:
      context: '..'
      dockerfile: './dev/Dockerfile'
      target: api
      tags:
        - azubitafel-api:latest
    container_name: 'api'
    restart: 'unless-stopped'
    volumes:
      - config:/config
    environment:
      - RUST_LOG=api=debug,common=debug,info
    command: ["/bin/api", "-c", "/config/config.toml"]

  kiosk:
    build:
      context: '..'
      dockerfile: './dev/Dockerfile'
      target: kiosk
      tags:
        - azubitafel-kiosk:latest
    devices:
      - /dev/dri:/dev/dri
      - /dev/input:/dev/input
    container_name: 'kiosk'
    restart: unless-stopped
    environment:
      - XDG_RUNTIME_DIR=/tmp
      - KIOSK_HOME=http://public
      - RUST_LOG=webview=debug,common=debug,info

volumes:
  data:
  config:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '../dev'
  www:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '../www/build'
